<html>
<head>
	<title>Wassersportzentrum Wettertafel</title>
	<meta charset="utf-8">

	<script src="js/jquery-1.9.1.min.js" ></script>

	<script src="js/highcharts.js"></script>
	<script src="js/highcharts-more.js"></script>

	<link href="css/bootstrap.min.css" rel="stylesheet">
	<link href="css/style.css" rel="stylesheet">

	<script src="js/charts.js"></script>
	<meta http-equiv="refresh" content="1800">
	<meta name="viewport" content="width=1000px" />
	<link rel="icon" sizes="32x32" href="img/favicon-152.png">
	<link rel="apple-touch-icon-precomposed" sizes="152x152" href="img/favicon-152.png"/>
</head>

<body>
	<div class="row">
		<div class="span4">
			<div id="dial-wind" class="widget"></div>
		</div>

		<div class="span4 map pos-rel">
			<div id="map-rain">
				<div class="map-widget">
					<!-- <img src="http://www.dwd.de/wundk/radar/Radarfilm_WEB_SE.gif" class="map-image" /> <!-- 4 Stunden, 3 MB -->
					<img src="http://images.wetterdienst.de/maps/radar/Radarfilm_Suedost.gif" class="map-image" /> <!-- 2,5 Std, 300KB -->
					<img src="img/map-pin.png" class="pin" />
					<img src="img/map-mask.png" class="mask" />
				</div>
				<h2>Niederschlagsradar</h2>
				<h3>der letzten 2,5 Stunden</h3>
			</div>
			<div id="icon-weather"></div>
			<div id="dial-temperature"></div>
		</div>

		<div class="span4 map pos-rel">
			<div id="map-lightning">
				<div class="map-widget">
					<!-- <img src="http://www.dwd.de/wundk/radar/Radarfilm_WEB_SE.gif" class="map-image" /> <!-- 4 Stunden, 3 MB -->
					<img src="http://images.blitzortung.org/Images/image_b_de.png" class="map-image" /> <!-- 2,5 Std, 300KB -->
					<img src="img/map-pin.png" class="pin" />
					<img src="img/map-mask.png" class="mask" />
				</div>
				<h2>Blitzradar</h2>
				<h3>der letzten 2,5 Stunden</h3>
			</div>
		</div>

		<!--
		<div class="span4">
			<div id="dial-pressure" class="widget" ></div>
		</div>
		-->
	</div>

	<div class="row">
		<div class="span12">
			<div id="chart-pressure" class="widget"></div>
		</div>
	</div>

	<div class="row">
		<div class="span12">
			<div id="chart-temp" class="widget"></div>
		</div>
	</div>

	<div class="row">
		<div class="span12">
			<div id="chart-wind" class="widget"></div>
		</div>
	</div>

	<div class="row">
		<div class="span12">
			<div id="chart-rain" class="widget"></div>
		</div>
	</div>
	<div class="row footer">
		<div class="span12">
			<div id="license">
				Vorhersagen: <a href="http://forecast.io/">forecast.io</a><br />
				Niederschlagsradar: <a href="http://dwd.de/">Deutscher Wetterdienst</a><br />
				Regenradar: <a href="http://blitzortung.org/">blitzortung.org</a>
			</div>
			<div id="date">
			</div>
			<div id="hostname">
			</div>
		</div>
	</div>
	<div class="row">
		<div id="loading" class="span12">Lade Daten...</div>
	</div>
</body>

<script type="text/javascript">
function ISODateString(d){
  function pad(n){return n<10 ? '0'+n : n}
  return d.getFullYear()+'-'
      + pad(d.getMonth()+1)+'-'
      + pad(d.getDate())+'T'
      + pad(d.getHours())+':'
      + pad(d.getMinutes())+':'
      + pad(d.getSeconds())
}

var dataReceived = false;

var date = new Date();
date.setHours(0);
date.setMilliseconds(0);
date.setMinutes(0);
date.setSeconds(0);

var minus1 = ISODateString(date)

date.setDate(date.getDate() - 1)
var minus2 = ISODateString(date)

jQuery(document).ready(function() {
	setTimeout(function () {
		if(!dataReceived) {
			location.reload(true);
		}
	}, 60000);

	$.when(
		$.ajax({
			url: "https://api.forecast.io/forecast/929a06588b68f79d5a6ed239dd55bd61/49.106389,10.987222," + minus1 + "?extend=hourly&units=si&callback=?",
			type: 'GET',
			dataType: 'jsonp',
			error: errorHandler
		}),
		$.ajax({
			url: "https://api.forecast.io/forecast/929a06588b68f79d5a6ed239dd55bd61/49.106389,10.987222," + minus2 + "?extend=hourly&units=si&callback=?",
			type: 'GET',
			dataType: 'jsonp',
			error: errorHandler
		}),
		$.ajax({
			url: "https://api.forecast.io/forecast/929a06588b68f79d5a6ed239dd55bd61/49.106389,10.987222?extend=hourly&units=si&callback=?",
			type: 'GET',
			dataType: 'jsonp',
			error: errorHandler
		})
		).done(
			function(a1, a2, a3){
				mergeData(a1[0], a2[0], a3[0]);
			});

		$.ajax({
			url: "./json/hostname.json",
			type: 'GET',
			dataType: 'json',
			error: errorHandler
		}).done(
			function(a1){
				placeHostname('hostname', a1.hostname)
			});
});


function mergeData(minus1, minus2, forecast)
{
	var span = Array();
	dataReceived = true;
	for(var i = 1; i < minus2.hourly.data.length; i ++) {
		if(minus2.hourly.data[i].time < minus1.hourly.data[0].time) {
			span.push(minus2.hourly.data[i])
		}
	}
	for(var i = 0; i < minus1.hourly.data.length; i ++) {
		if(minus1.hourly.data[i].time < forecast.hourly.data[0].time) {
			span.push(minus1.hourly.data[i])
		}
	}
	for(var i = 0; i <  forecast.hourly.data.length; i ++) {
		span.push(forecast.hourly.data[i])
	}
	var current = forecast.currently
	renderData(span, forecast.hourly.data, current);
}

function renderData(span, future, current)
{
	hide('loading');
	show('map-rain');
	show('map-lightning');

	dialTemperature('dial-temperature', current);
	placeIcon('icon-weather', current);

	dialWind('dial-wind', future);
	plotPressure('chart-pressure', span, current);
	plotTemperature('chart-temp', span);
	plotWindSpeed('chart-wind', span);
	plotRain('chart-rain', span);
	placeDate('date', span);
}

function  errorHandler(e)
{
	console.log(e.status +' '+e.statusText);
}

</script>


</html>
